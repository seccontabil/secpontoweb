<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apontamento de Horas Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }
        /* Styles for custom searchable dropdown */
        .searchable-dropdown {
            position: relative;
        }
        .searchable-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            /* Z-index fix: Ensure dropdown is above modal content */
            z-index: 60; 
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .searchable-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .searchable-dropdown-item:hover, .searchable-dropdown-item.highlighted {
            background-color: #eff6ff;
        }
         .searchable-dropdown-item small {
            color: #6b7280;
         }
         .payment-type-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            z-index: 10;
         }
         /* Tooltip for notes - Global Tooltip */
        #global-tooltip {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: left;
            white-space: pre-wrap;
            border-radius: 6px;
            padding: 8px 12px;
            position: fixed; /* Use fixed to escape all parent containers */
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 250px;
            pointer-events: none; /* So it doesn't interfere with mouse events */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="max-w-md w-full p-8 bg-white rounded-xl shadow-md border border-slate-200 relative">
                <button id="close-auth-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
                <!-- Login Form -->
                <div id="login-view">
                    <h2 class="text-2xl font-bold text-center mb-6">Entrar no Sistema</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <input type="email" id="login-email" class="w-full p-2 border border-slate-300 rounded-lg" required autocomplete="email">
                        </div>
                        <div class="mb-4">
                            <label for="login-password" class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                            <input type="password" id="login-password" class="w-full p-2 border border-slate-300 rounded-lg" required autocomplete="current-password">
                        </div>
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-slate-700">Manter conectado</label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Entrar</button>
                        <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    </form>
                    <p class="text-center text-sm mt-4">
                        Não tem uma conta? <a href="#" id="show-register-view" class="font-medium text-blue-600 hover:underline">Cadastre-se</a>
                    </p>
                </div>
                <!-- Register Form -->
                <div id="register-view" class="hidden">
                    <h2 class="text-2xl font-bold text-center mb-6">Criar Conta</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-email" class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <input type="email" id="register-email" class="w-full p-2 border border-slate-300 rounded-lg" required autocomplete="email">
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-sm font-medium text-slate-700 mb-1">Senha (mínimo 6 caracteres)</label>
                            <input type="password" id="register-password" class="w-full p-2 border border-slate-300 rounded-lg" required autocomplete="new-password">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Criar Conta</button>
                        <p id="register-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
                    </form>
                    <p class="text-center text-sm mt-4">
                        Já tem uma conta? <a href="#" id="show-login-view" class="font-medium text-blue-600 hover:underline">Entrar</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Loading state -->
        <div id="loading" class="text-center p-8">
            <p class="text-slate-500">Carregando...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <main id="main-content" class="hidden">
            <header class="mb-8 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Apontamento de Horas Web</h1>
                    <p class="text-slate-600 mt-1">Gerencie as horas de trabalho da sua equipe de forma simples e eficiente.</p>
                </div>
                <div class="text-right">
                    <button id="login-btn" class="hidden bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg shadow-sm hover:bg-slate-200 transition">Fazer Login / Cadastrar</button>
                    <div id="user-info" class="hidden">
                        <p id="user-email" class="text-sm text-slate-600 font-medium"></p>
                        <button id="logout-btn" class="text-sm text-blue-600 hover:underline">Sair</button>
                    </div>
                </div>
            </header>
            
            <!-- Global Settings -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                <h2 class="text-xl font-semibold mb-4">Selecione o Período</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="month-select" class="block text-sm font-medium text-slate-700 mb-1">Mês</label>
                        <select id="month-select" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="year-select" class="block text-sm font-medium text-slate-700 mb-1">Ano</label>
                        <input type="number" id="year-select" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button class="tab-button active" data-tab="funcionarios">Funcionários</button>
                    <button class="tab-button" data-tab="empresas">Empresas</button>
                    <button class="tab-button" data-tab="apontamentos">Apontamentos</button>
                    <button class="tab-button" data-tab="relatorio">Relatório</button>
                    <button class="tab-button" data-tab="configuracoes">Configurações</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Funcionarios Tab -->
                <div id="funcionarios-tab" class="tab-pane active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="search-employee" placeholder="Pesquisar por nome..." class="md:col-span-1 w-full p-2 border border-slate-300 rounded-lg shadow-sm">
                        <div id="filter-company-container" class="md:col-span-1 w-full"></div>
                        <button id="add-employee-btn" class="md:col-start-3 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition justify-self-end">Adicionar Funcionário</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-200 text-slate-700 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4">Nome</th>
                                        <th class="p-4">Empresa</th>
                                        <th class="p-4">Carga Horária</th>
                                        <th class="p-4">Remuneração (R$)</th>
                                        <th class="p-4">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="employee-list" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Empresas Tab -->
                <div id="empresas-tab" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Gerenciar Empresas</h3>
                        <button id="add-company-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition">Adicionar Empresa</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-200 text-slate-700 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4">Código</th>
                                        <th class="p-4">Nome</th>
                                        <th class="p-4">CNPJ</th>
                                        <th class="p-4">Funcionários</th>
                                        <th class="p-4">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="company-list-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Apontamentos Tab -->
                <div id="apontamentos-tab" class="tab-pane hidden">
                     <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-grow">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Selecione a Empresa</label>
                                <div id="apontamento-company-container"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Selecione o Funcionário</label>
                                <div id="apontamento-employee-container"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 self-end">
                            <span id="save-status" class="text-sm text-slate-500 font-medium"></span>
                            <button id="save-timesheet-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 transition disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>Salvar Alterações</button>
                            <button id="export-xls-btn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-emerald-700 transition">Exportar XLS</button>
                            <button id="export-pdf-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700 transition">Imprimir / Gerar PDF</button>
                        </div>
                    </div>
                    <div id="timesheet-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-200 text-slate-700 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-3 text-center">Dia</th>
                                        <th class="p-3">Carga Dia</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Ent. 1</th>
                                        <th class="p-3">Saí. 1</th>
                                        <th class="p-3">Ent. 2</th>
                                        <th class="p-3">Saí. 2</th>
                                        <th class="p-3 text-center">Feriado</th>
                                        <th class="p-3 text-center">Total Trab.</th>
                                        <th class="p-3 text-center">Saldo</th>
                                        <th class="p-3">H.E. 50%</th>
                                        <th class="p-3">H.E. 100%</th>
                                        <th class="p-3">Ad. Noturno</th>
                                    </tr>
                                </thead>
                                <tbody id="timesheet-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Monthly Summary -->
                    <div id="timesheet-summary" class="mt-6"></div>
                </div>

                <!-- Relatorio Tab -->
                <div id="relatorio-tab" class="tab-pane hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Filtrar por Empresa</label>
                        <div id="report-company-container" class="max-w-md"></div>
                    </div>
                     <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-200 text-slate-700 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4">Nome</th>
                                        <th class="p-4 text-center">Total Trab.</th>
                                        <th class="p-4 text-center">Saldo</th>
                                        <th class="p-4 text-center">Faltas</th>
                                        <th class="p-4 text-right">H. Extra 50%</th>
                                        <th class="p-4 text-right">H. Extra 100%</th>
                                        <th class="p-4 text-right">Ad. Noturno</th>
                                        <th class="p-4 text-right font-bold">Total Variáveis (R$)</th>
                                    </tr>
                                </thead>
                                <tbody id="report-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Configurações Tab -->
                <div id="configuracoes-tab" class="tab-pane hidden">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold mb-4">Configurações de Cálculo</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="font-medium mb-2">Adicional Noturno</h4>
                                <div class="flex items-center gap-4">
                                    <div>
                                        <label for="nightly-start" class="block text-sm text-slate-600 mb-1">Início</label>
                                        <input type="time" id="nightly-start" value="22:00" class="setting-input w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label for="nightly-end" class="block text-sm text-slate-600 mb-1">Fim</label>
                                        <input type="time" id="nightly-end" value="05:00" class="setting-input w-full p-2 border border-slate-300 rounded-lg">
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">Define o período de trabalho considerado como noturno.</p>
                            </div>
                             <div>
                                <h4 class="font-medium mb-2">Percentual do Adicional Noturno</h4>
                                <div>
                                    <label for="nightly-percentage" class="block text-sm text-slate-600 mb-1">Percentual (%)</label>
                                    <input type="number" id="nightly-percentage" value="20" step="0.1" class="setting-input w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <p class="text-xs text-slate-500 mt-2">Valor percentual a ser adicionado sobre a hora normal.</p>
                            </div>
                            <!-- FEATURE: Balance Tolerance -->
                             <div>
                                <h4 class="font-medium mb-2">Tolerância do Saldo Diário</h4>
                                <div>
                                    <label for="balance-tolerance" class="block text-sm text-slate-600 mb-1">Minutos (ex: 10)</label>
                                    <input type="number" id="balance-tolerance" value="0" step="1" class="setting-input w-full p-2 border border-slate-300 rounded-lg">
                                </div>
                                <p class="text-xs text-slate-500 mt-2">Saldos diários (positivos ou negativos) dentro desta tolerância serão zerados.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-xl font-bold mb-4">Adicionar Funcionário</h2>
            <form id="employee-form">
                <input type="hidden" id="employee-id">
                <div class="grid grid-cols-1 gap-4">
                    <div id="employee-name-wrapper">
                        <label for="employee-name" class="block text-sm font-medium text-slate-700">Nome</label>
                        <input type="text" id="employee-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="employee-company-select" class="block text-sm font-medium text-slate-700">Empresa</label>
                        <div id="employee-company-container" class="mt-1 w-full"></div>
                        <p id="employee-company-error" class="text-red-500 text-xs mt-1 h-3"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Tipo de Pagamento</label>
                        <div class="mt-1 flex rounded-md shadow-sm payment-type-container">
                            <button type="button" data-type="monthly" class="payment-type-btn relative inline-flex items-center space-x-2 rounded-l-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">Mensalista</button>
                            <button type="button" data-type="hourly" class="payment-type-btn relative -ml-px inline-flex items-center space-x-2 rounded-r-md border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50">Horista</button>
                        </div>
                        <input type="hidden" id="employee-payment-type" value="monthly">
                    </div>
                     <div id="salary-wrapper">
                        <label for="employee-salary" id="salary-label" class="block text-sm font-medium text-slate-700">Salário (R$)</label>
                        <input type="number" id="employee-salary" step="0.01" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2">
                    </div>
                    <div id="workload-wrapper">
                        <label for="employee-workload" class="block text-sm font-medium text-slate-700">Carga Horária Padrão</label>
                        <input type="text" id="employee-workload" value="08:00" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2" required placeholder="HH:MM">
                    </div>
                    <div>
                        <label for="employee-notes" class="block text-sm font-medium text-slate-700">Anotações</label>
                        <textarea id="employee-notes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="company-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 id="company-modal-title" class="text-xl font-bold mb-4">Adicionar Empresa</h2>
            <form id="company-form">
                <input type="hidden" id="company-id">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="company-code" class="block text-sm font-medium text-slate-700">Código</label>
                        <input type="text" id="company-code" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="company-name" class="block text-sm font-medium text-slate-700">Nome</label>
                        <input type="text" id="company-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="company-cnpj" class="block text-sm font-medium text-slate-700">CNPJ (Opcional)</label>
                        <input type="text" id="company-cnpj" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="company-notes" class="block text-sm font-medium text-slate-700">Anotações</label>
                        <textarea id="company-notes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-company-btn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-2">Confirmar Exclusão</h2>
            <p id="delete-confirm-text" class="text-slate-600 mb-6">Tem certeza?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-delete-btn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Global Tooltip -->
    <div id="global-tooltip"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, setPersistence, browserSessionPersistence, indexedDBLocalPersistence, EmailAuthProvider, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
        	apiKey: "AIzaSyBg7h3RKlR0RYubNGmLJf8CS8ZTlzLR2JU",
    		authDomain: "secpontoweb.firebaseapp.com",
    		projectId: "secpontoweb",
    		storageBucket: "secpontoweb.firebasestorage.app",
    		messagingSenderId: "729335173965",
    		appId: "1:729335173965:web:fe28066a984b8e70871d04",
    		measurementId: "G-E136J5R8GC"
        };
        const appId = 'secpontoweb';
        let db, auth, userId;
        let unsubscribeCompanies, unsubscribeEmployees, unsubscribeTimesheets, unsubscribeSettings;

        // --- ELEMENTOS DA UI ---
        const loadingEl = document.getElementById('loading');
        const mainContentEl = document.getElementById('main-content');
        const authModal = document.getElementById('auth-modal');
        const closeAuthModalBtn = document.getElementById('close-auth-modal');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterViewBtn = document.getElementById('show-register-view');
        const showLoginViewBtn = document.getElementById('show-login-view');
        const loginBtn = document.getElementById('login-btn');
        const userInfoEl = document.getElementById('user-info');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const loginErrorEl = document.getElementById('login-error');
        const registerErrorEl = document.getElementById('register-error');
        
        const employeeList = document.getElementById('employee-list');
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const employeeModal = document.getElementById('employee-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const employeeForm = document.getElementById('employee-form');
        const modalTitle = document.getElementById('modal-title');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const timesheetBody = document.getElementById('timesheet-body');
        const timesheetSummaryEl = document.getElementById('timesheet-summary');
        const reportBody = document.getElementById('report-body');
        const searchEmployeeInput = document.getElementById('search-employee');
        const filterCompanyContainer = document.getElementById('filter-company-container');
        const employeeCompanyContainer = document.getElementById('employee-company-container');
        const employeeCompanyError = document.getElementById('employee-company-error');
        const apontamentoCompanyContainer = document.getElementById('apontamento-company-container');
        const apontamentoEmployeeContainer = document.getElementById('apontamento-employee-container');
        const reportCompanyContainer = document.getElementById('report-company-container');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportXlsBtn = document.getElementById('export-xls-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const deleteConfirmText = document.getElementById('delete-confirm-text');
        const addCompanyBtn = document.getElementById('add-company-btn');
        const companyListBody = document.getElementById('company-list-body');
        const companyModal = document.getElementById('company-modal');
        const companyForm = document.getElementById('company-form');
        const cancelCompanyBtn = document.getElementById('cancel-company-btn');
        const saveTimesheetBtn = document.getElementById('save-timesheet-btn');
        const saveStatusEl = document.getElementById('save-status');
        const globalTooltip = document.getElementById('global-tooltip');


        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            employees: [],
            companies: [],
            timesheets: {},
            localTimesheet: {},
            currentEmployeeId: null,
            apontamentoCompanyId: null,
            reportCompanyFilter: '',
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            searchTerm: '',
            companyFilter: '',
            hasUnsavedChanges: false,
        };
        let itemToDelete = { id: null, type: null, name: '' };
        let employeeModalState = null;
        let companyToCreateFromModal = null;
        let apontamentoCompanyInput = null;
        let apontamentoEmployeeInput = null;
        let filterCompanyInput = null;
        let cleanupNameSuggestions = null;
        let appComponentsInitialized = false;

        const statusMap = {
            workday: 'Trabalho',
            absent: 'Falta',
            day_off: 'Folga',
            certificate: 'Atestado'
        };

        // --- FUNÇÕES DE LÓGICA E CÁLCULO ---
        const roundUp = (num, places) => { const factor = Math.pow(10, places); return Math.ceil(num * factor) / factor; };
        const timeToDecimal = (timeStr) => { if (!timeStr || !/^\d{2}:\d{2}$/.test(timeStr)) return 0; const [hours, minutes] = timeStr.split(':').map(Number); if (isNaN(hours) || isNaN(minutes)) return 0; return hours + (minutes / 60); };
        const decimalToMinutes = (decimalHours) => { if (isNaN(decimalHours) || decimalHours === null) return 0; return Math.round(decimalHours * 60); };
        const minutesToTime = (minutes, showSignal = false) => { if (isNaN(minutes) || minutes === null) return "00:00"; const sign = minutes < 0 ? "-" : (showSignal ? "+" : ""); const absMinutes = Math.abs(Math.round(minutes)); const h = Math.floor(absMinutes / 60).toString().padStart(2, '0'); const m = (absMinutes % 60).toString().padStart(2, '0'); return `${sign}${h}:${m}`; };
        const formatDecimal = (decimalHours) => { if (isNaN(decimalHours) || decimalHours === null) return "0.00"; return decimalHours.toFixed(2); };
        const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        const calculateIntervalOverlap = (start1, end1, start2, end2) => {
            const overlapStart = Math.max(start1, start2);
            const overlapEnd = Math.min(end1, end2);
            return Math.max(0, overlapEnd - overlapStart);
        };

        const calculateNightlyOverlap = (workStart, workEnd) => {
            if (workStart === workEnd) return 0;
            const nightStart = timeToDecimal(document.getElementById('nightly-start').value);
            const nightEnd = timeToDecimal(document.getElementById('nightly-end').value);
            let totalOverlap = 0;
            if (nightStart <= nightEnd) { 
                if (workStart < workEnd) { totalOverlap += calculateIntervalOverlap(workStart, workEnd, nightStart, nightEnd); }
                else { totalOverlap += calculateIntervalOverlap(workStart, 24, nightStart, nightEnd); totalOverlap += calculateIntervalOverlap(0, workEnd, nightStart, nightEnd); }
            } else { 
                const nightPeriod1 = { start: nightStart, end: 24 };
                const nightPeriod2 = { start: 0, end: nightEnd }; 
                if (workStart < workEnd) { 
                    totalOverlap += calculateIntervalOverlap(workStart, workEnd, nightPeriod1.start, nightPeriod1.end); 
                    totalOverlap += calculateIntervalOverlap(workStart, workEnd, nightPeriod2.start, nightPeriod2.end);
                } else {
                    const workPeriod1 = { start: workStart, end: 24 };
                    const workPeriod2 = { start: 0, end: workEnd };
                    totalOverlap += calculateIntervalOverlap(workPeriod1.start, workPeriod1.end, nightPeriod1.start, nightPeriod1.end);
                    totalOverlap += calculateIntervalOverlap(workPeriod2.start, workPeriod2.end, nightPeriod2.start, nightPeriod2.end);
                }
            }
            return totalOverlap;
        };
        
        const calculateDayTotals = (dayData, employee) => {
            const { workload = '08:00', paymentType = 'monthly' } = employee || {};
            const { status = 'workday', is_holiday = false, daily_workload = workload } = dayData;
            const workloadHours = timeToDecimal(daily_workload);

            const nonWorkResult = { totalWorkedHours: 0, balanceHours: 0, overtime50Hours: 0, overtime100Hours: 0, nightlyHours: 0, nightlyHoursRaw: 0 };
            if (status === 'absent') return { ...nonWorkResult, balanceHours: -workloadHours };
            if (['day_off', 'certificate'].includes(status)) return nonWorkResult;
            
            const entry1 = timeToDecimal(dayData.entry1), exit1 = timeToDecimal(dayData.exit1), entry2 = timeToDecimal(dayData.entry2), exit2 = timeToDecimal(dayData.exit2);
            const isPair1Complete = dayData.entry1 && dayData.exit1;
            const isPair2Complete = dayData.entry2 && dayData.exit2;
            
            let period1 = isPair1Complete ? (exit1 >= entry1 ? exit1 - entry1 : (24 - entry1) + exit1) : 0;
            let period2 = isPair2Complete ? (exit2 >= entry2 ? exit2 - entry2 : (24 - entry2) + exit2) : 0;
            const totalWorkedHours = period1 + period2;
            
            let nightlyHoursRaw = 0;
            if (isPair1Complete) nightlyHoursRaw += calculateNightlyOverlap(entry1, exit1);
            if (isPair2Complete) nightlyHoursRaw += calculateNightlyOverlap(entry2, exit2);
            
            const nightlyHoursComputed = nightlyHoursRaw * (60 / 52.5);
            
            const balanceToleranceHours = (parseInt(document.getElementById('balance-tolerance').value) || 0) / 60;
            const rawBalanceHours = totalWorkedHours - workloadHours;
            const balanceHours = Math.abs(rawBalanceHours) <= balanceToleranceHours ? 0 : rawBalanceHours;
            
            let finalOvertime50 = 0;
            let finalOvertime100 = 0;
            if (paymentType === 'hourly') {
                finalOvertime100 = is_holiday ? totalWorkedHours : 0;
            } else {
                finalOvertime50 = is_holiday ? 0 : Math.max(0, balanceHours);
                finalOvertime100 = is_holiday ? totalWorkedHours : 0;
            }

            return { 
                totalWorkedHours: roundUp(totalWorkedHours, 2), 
                balanceHours: roundUp(balanceHours, 2), 
                overtime50Hours: roundUp(finalOvertime50, 2), 
                overtime100Hours: roundUp(finalOvertime100, 2), 
                nightlyHours: roundUp(nightlyHoursComputed, 2), 
                nightlyHoursRaw: roundUp(nightlyHoursRaw, 2)
            };
        };
        
        // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
        const updateSaveStatus = (isSaving = false, isSaved = false) => {
            if (isSaving) { saveStatusEl.textContent = 'Salvando...'; saveTimesheetBtn.disabled = true; saveTimesheetBtn.textContent = 'Salvando...'; }
            else if (isSaved) { saveStatusEl.textContent = 'Salvo!'; saveTimesheetBtn.disabled = true; saveTimesheetBtn.textContent = 'Salvar Alterações'; setTimeout(() => { if(saveStatusEl.textContent === 'Salvo!') { saveStatusEl.textContent = ''; } }, 2500); }
            else if (state.hasUnsavedChanges) { saveStatusEl.textContent = 'Alterações não salvas'; saveTimesheetBtn.disabled = false; saveTimesheetBtn.textContent = 'Salvar Alterações'; }
            else { saveStatusEl.textContent = ''; saveTimesheetBtn.disabled = true; saveTimesheetBtn.textContent = 'Salvar Alterações'; }
        };

        const populateDateSelectors = () => {
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            monthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === state.currentMonth ? 'selected' : ''}>${month}</option>`).join('');
            yearSelect.value = state.currentYear;
        };
        
        const renderCompanyList = () => {
            const employeeCounts = state.employees.reduce((acc, emp) => {
                if (emp.companyId) acc[emp.companyId] = (acc[emp.companyId] || 0) + 1;
                return acc;
            }, {});

            companyListBody.innerHTML = state.companies.map(c => {
                const notesIcon = c.notes ? `<span class="has-tooltip-icon ml-2 cursor-help" data-notes="${c.notes}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-slate-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082.38-2.29.287-.082-.38.45-.083a.5.5 0 0 0 .288-.469l.738-3.468c.064-.293-.006-.399-.287-.47l-.45-.082-.082-.38 2.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg></span>` : '';
                return `
                <tr data-id="${c.id}">
                    <td class="p-4 font-medium">${c.codigo}</td>
                    <td class="p-4"><div class="flex items-center">${c.nome}${notesIcon}</div></td>
                    <td class="p-4">${c.cnpj || '-'}</td>
                    <td class="p-4 font-medium">${employeeCounts[c.id] || 0}</td>
                    <td class="p-4 space-x-2 whitespace-nowrap">
                        <button class="view-employees-btn text-sky-600 hover:text-sky-800" title="Ver Funcionários">Ver</button>
                        <button class="add-employee-to-company-btn text-green-600 hover:text-green-800" title="Adicionar Funcionário a esta Empresa">Adic.</button>
                        <button class="edit-company-btn text-blue-600 hover:text-blue-800" title="Editar Empresa">Editar</button>
                        <button class="delete-company-btn text-red-600 hover:text-red-800" title="Excluir Empresa">Excluir</button>
                    </td>
                </tr>`;
            }).join(''); 
        };

        const renderEmployeeList = () => {
            const filteredEmployees = state.employees.filter(emp => emp.name.toLowerCase().includes(state.searchTerm.toLowerCase()) && (state.companyFilter === '' || emp.companyId === state.companyFilter));
            employeeList.innerHTML = filteredEmployees.map(emp => {
                const company = state.companies.find(c => c.id === emp.companyId);
                const companyName = company ? `${company.codigo} - ${company.nome}` : '<span class="text-red-500">Sem empresa</span>';
                const salaryDisplay = emp.paymentType === 'hourly' ? `${parseFloat(emp.salary || 0).toFixed(2)} / hora` : (emp.salary && parseFloat(emp.salary) > 0 ? parseFloat(emp.salary).toFixed(2) : '-');
                const workloadDisplay = emp.paymentType === 'hourly' ? 'N/A' : (emp.workload || '08:00');
                const notesIcon = emp.notes ? `<span class="has-tooltip-icon ml-2 cursor-help" data-notes="${emp.notes}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle text-slate-500" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082.38-2.29.287-.082-.38.45-.083a.5.5 0 0 0 .288-.469l.738-3.468c.064-.293-.006-.399-.287-.47l-.45-.082-.082-.38 2.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg></span>` : '';

                return `<tr data-id="${emp.id}">
                    <td class="p-4 font-medium"><div class="flex items-center">${emp.name}${notesIcon}</div></td>
                    <td class="p-4">${companyName}</td>
                    <td class="p-4">${workloadDisplay}</td>
                    <td class="p-4">${salaryDisplay}</td>
                    <td class="p-4 space-x-2 whitespace-nowrap">
                        <button class="go-to-timesheet-btn text-green-600 hover:text-green-800 font-semibold">Apontamentos</button>
                        <button class="edit-btn text-blue-600 hover:text-blue-800">Editar</button>
                        <button class="delete-btn text-red-600 hover:text-red-800">Excluir</button>
                    </td>
                </tr>`;
            }).join('');
        };

        const renderTimesheet = () => {
            const currentEmployee = state.employees.find(e => e.id === state.currentEmployeeId);
            if (!currentEmployee) {
                timesheetBody.innerHTML = `<tr><td colspan="13" class="p-4 text-center text-slate-500">Selecione uma empresa e um funcionário para ver os apontamentos.</td></tr>`;
                timesheetSummaryEl.innerHTML = '';
                return;
            }
            const timesheetId = `${state.currentEmployeeId}_${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
            state.localTimesheet = JSON.parse(JSON.stringify(state.timesheets[timesheetId] || {}));
            state.hasUnsavedChanges = false;
            updateSaveStatus();
            
            const daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            timesheetBody.innerHTML = days.map(day => {
                const dayStr = day.toString().padStart(2, '0');
                const date = new Date(state.currentYear, state.currentMonth, day);
                const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0, 3);
                
                const dayIndex = date.getDay();
                const isWeekend = dayIndex === 0 || dayIndex === 6;
                const weekendDayClass = isWeekend ? 'text-red-600 font-semibold' : '';
                const weekendTextClass = isWeekend ? 'text-red-600' : 'text-slate-500';

                const dayData = state.localTimesheet[dayStr] || {};
                const { totalWorkedHours, balanceHours, overtime50Hours, overtime100Hours, nightlyHoursRaw } = calculateDayTotals(dayData, currentEmployee);
                const status = dayData.status || 'workday';
                const isWorkday = !['absent', 'day_off', 'certificate'].includes(status);
                const workloadDisplay = currentEmployee.paymentType === 'hourly' ? 'N/A' : (dayData.daily_workload || currentEmployee.workload);
                const balanceDisplay = currentEmployee.paymentType === 'hourly' ? 'N/A' : minutesToTime(decimalToMinutes(balanceHours), true);
                const balanceClass = balanceHours < 0 ? 'text-red-500' : 'text-green-600';
                const extra50 = dayData.manual_extra50 ? dayData.extra50 : minutesToTime(decimalToMinutes(overtime50Hours));
                const extra100 = dayData.manual_extra100 ? dayData.extra100 : minutesToTime(decimalToMinutes(overtime100Hours));
                
                return `<tr class="hover:bg-slate-50 ${!isWorkday ? 'bg-slate-200 text-slate-600' : ''}">
                    <td class="p-2 text-center font-medium"><div class="flex items-center justify-center space-x-2 ${weekendDayClass}"><span>${dayStr}</span><span class="text-xs ${weekendTextClass}">${dayOfWeek}</span></div></td>
                    <td><input type="text" placeholder="HH:MM" class="workload-input w-24 p-1.5 border border-transparent hover:border-slate-300 focus:border-blue-500 bg-transparent rounded-md" data-day="${dayStr}" data-field="daily_workload" value="${workloadDisplay}" ${!isWorkday || currentEmployee.paymentType === 'hourly' ? 'disabled' : ''}></td>
                    <td><select class="status-select w-full p-1.5 border border-transparent hover:border-slate-300 bg-transparent rounded-md text-sm" data-day="${dayStr}" data-field="status"><option value="workday" ${status === 'workday' ? 'selected' : ''}>Trabalho</option><option value="absent" ${status === 'absent' ? 'selected' : ''}>Falta</option><option value="day_off" ${status === 'day_off' ? 'selected' : ''}>Folga</option><option value="certificate" ${status === 'certificate' ? 'selected' : ''}>Atestado</option></select></td>
                    ${['entry1', 'exit1', 'entry2', 'exit2'].map(field => `<td><input type="text" placeholder="HH:MM" class="time-input w-24 p-1.5 border border-transparent hover:border-slate-300 focus:border-blue-500 bg-transparent rounded-md" data-day="${dayStr}" data-field="${field}" value="${dayData[field] || ''}" ${!isWorkday ? 'disabled' : ''}></td>`).join('')}
                    <td class="p-2 text-center"><input type="checkbox" class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500" data-day="${dayStr}" data-field="is_holiday" ${dayData.is_holiday ? 'checked' : ''}></td>
                    <td class="p-2 text-center text-slate-600 font-semibold">${minutesToTime(decimalToMinutes(totalWorkedHours))}</td>
                    <td class="p-2 text-center font-semibold ${balanceClass}">${balanceDisplay}</td>
                    <td><input type="text" placeholder="HH:MM" class="manual-input w-24 p-1.5 border border-transparent hover:border-slate-300 focus:border-blue-500 bg-transparent rounded-md" data-day="${dayStr}" data-field="extra50" value="${extra50}" ${!isWorkday ? 'disabled' : ''}></td>
                    <td><input type="text" placeholder="HH:MM" class="manual-input w-24 p-1.5 border border-transparent hover:border-slate-300 focus:border-blue-500 bg-transparent rounded-md" data-day="${dayStr}" data-field="extra100" value="${extra100}" ${!isWorkday ? 'disabled' : ''}></td>
                    <td class="p-2 text-center text-slate-600 font-semibold">${minutesToTime(decimalToMinutes(nightlyHoursRaw))}</td>
                </tr>`;
            }).join('');
            renderTimesheetSummary();
        };

        const calculateMonthTotals = (employee, timesheetData) => {
            const dataToCalculate = timesheetData || state.timesheets[`${employee.id}_${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`] || {};
            const totals = { totalWorked: 0, balance: 0, extra50: 0, extra100: 0, nightly: 0, nightlyRaw: 0, absences: 0 };
            
            Object.values(dataToCalculate).forEach(dayData => {
                if (dayData.status === 'absent') {
                    totals.absences++;
                }
                const dayTotals = calculateDayTotals(dayData, employee);
                totals.totalWorked += dayTotals.totalWorkedHours;
                
                if (employee.paymentType !== 'hourly') {
                    totals.balance += dayTotals.balanceHours;
                }

                totals.extra100 += dayData.manual_extra100 ? timeToDecimal(dayData.extra100) : dayTotals.overtime100Hours;
                totals.nightly += dayData.manual_nightly ? timeToDecimal(dayData.nightly) : dayTotals.nightlyHours;
                totals.nightlyRaw += dayTotals.nightlyHoursRaw;
            });

            if (employee.paymentType !== 'hourly') {
                if (totals.balance > 0) {
                    totals.extra50 = totals.balance;
                    totals.balance = 0;
                } else {
                    totals.extra50 = 0;
                }
            } else {
                totals.balance = 0;
                totals.extra50 = 0;
            }
            
            return {
                totalWorked: roundUp(totals.totalWorked, 2),
                balance: roundUp(totals.balance, 2),
                extra50: roundUp(totals.extra50, 2),
                extra100: roundUp(totals.extra100, 2),
                nightly: roundUp(totals.nightly, 2),
                nightlyRaw: roundUp(totals.nightlyRaw, 2),
                absences: totals.absences
            };
        };

        const renderTimesheetSummary = () => {
            const employee = state.employees.find(e => e.id === state.currentEmployeeId);
            if (!employee) {
                timesheetSummaryEl.innerHTML = '';
                return;
            }

            const monthTotals = calculateMonthTotals(employee, state.localTimesheet);
            const balanceDisplay = employee.paymentType === 'hourly' ? 'N/A' : minutesToTime(decimalToMinutes(monthTotals.balance), true);
            const balanceClass = monthTotals.balance < 0 ? 'text-red-500' : 'text-green-600';

            const summaryItem = (label, valueHours, customClass = 'text-slate-800') => `
                <div class="p-4 bg-slate-50 rounded-lg">
                    <p class="text-sm font-medium text-slate-600">${label}</p>
                    <div class="flex items-baseline gap-2">
                        <p class="text-2xl font-bold ${customClass}">${minutesToTime(decimalToMinutes(valueHours))}</p>
                        <span class="text-sm text-slate-500">(${formatDecimal(valueHours)})</span>
                    </div>
                </div>`;
            
            timesheetSummaryEl.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">Resumo do Mês</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-x-6 gap-y-4">
                        ${summaryItem('Total Trabalhado', monthTotals.totalWorked)}
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm font-medium text-slate-600">Saldo (Banco)</p>
                            <div class="flex items-baseline gap-2">
                                <p class="text-2xl font-bold ${balanceClass}">${balanceDisplay}</p>
                                ${employee.paymentType !== 'hourly' ? `<span class="text-sm text-slate-500">(${formatDecimal(monthTotals.balance)})</span>` : ''}
                            </div>
                        </div>
                         <div class="p-4 bg-slate-50 rounded-lg">
                            <p class="text-sm font-medium text-slate-600">Faltas (dias)</p>
                            <p class="text-2xl font-bold text-slate-800">${monthTotals.absences}</p>
                        </div>
                        ${summaryItem('H.E. 50%', monthTotals.extra50)}
                        ${summaryItem('H.E. 100%', monthTotals.extra100)}
                        ${summaryItem('Adic. Noturno (Pago)', monthTotals.nightly)}
                    </div>
                </div>
            `;
        };

        const renderReport = () => {
            const nightlyPercentage = parseFloat(document.getElementById('nightly-percentage').value) / 100 || 0.2;
            const employeesToReport = state.reportCompanyFilter ? state.employees.filter(emp => emp.companyId === state.reportCompanyFilter) : state.employees;
            
            const timeCell = (decimalHours, isBalance = false) => {
                const balanceClass = decimalHours < 0 ? 'text-red-500' : 'text-green-500';
                const displayTime = isBalance ? minutesToTime(decimalToMinutes(decimalHours), true) : minutesToTime(decimalToMinutes(decimalHours));
                const displayDecimal = `(${formatDecimal(decimalHours)})`;
                return `<div class="${isBalance ? balanceClass : ''}">${displayTime}</div><div class="text-xs text-slate-500 ${isBalance ? balanceClass : ''}">${displayDecimal}</div>`;
            };

            reportBody.innerHTML = employeesToReport.map(emp => {
                const monthTotals = calculateMonthTotals(emp); 
                const hourlyRate = (emp.paymentType === 'hourly') ? parseFloat(emp.salary || 0) : (parseFloat(emp.salary || 0) / 220);
                let totalVariablesDisplay = '-', extra50Display, extra100Display, nightlyDisplay;
                if (emp.paymentType === 'hourly') {
                    const basePay = (monthTotals.totalWorked - monthTotals.extra100) * hourlyRate;
                    const holidayPay = monthTotals.extra100 * hourlyRate * 2;
                    const nightlyBonusValue = monthTotals.nightly * hourlyRate * nightlyPercentage;
                    totalVariablesDisplay = `Total: ${formatCurrency(basePay + holidayPay + nightlyBonusValue)}`;
                    extra50Display = timeCell(0);
                    extra100Display = formatCurrency(holidayPay);
                    nightlyDisplay = formatCurrency(nightlyBonusValue);
                } else {
                    const extra50Value = monthTotals.extra50 * hourlyRate * 1.5;
                    const extra100Value = monthTotals.extra100 * hourlyRate * 2.0;
                    const nightlyValue = monthTotals.nightly * hourlyRate * nightlyPercentage;
                    totalVariablesDisplay = formatCurrency(extra50Value + extra100Value + nightlyValue);
                    extra50Display = hourlyRate > 0 ? formatCurrency(extra50Value) : timeCell(monthTotals.extra50);
                    extra100Display = hourlyRate > 0 ? formatCurrency(extra100Value) : timeCell(monthTotals.extra100);
                    nightlyDisplay = hourlyRate > 0 ? formatCurrency(nightlyValue) : timeCell(monthTotals.nightly);
                }
                const balanceDisplay = emp.paymentType === 'hourly' ? 'N/A' : timeCell(monthTotals.balance, true);
                
                return `<tr class="hover:bg-slate-50">
                            <td class="p-4 font-medium">${emp.name}</td>
                            <td class="p-4 text-center font-semibold">${timeCell(monthTotals.totalWorked)}</td>
                            <td class="p-4 text-center font-semibold">${balanceDisplay}</td>
                            <td class="p-4 text-center font-semibold">${monthTotals.absences}</td>
                            <td class="p-4 text-right">${extra50Display}</td>
                            <td class="p-4 text-right">${extra100Display}</td>
                            <td class="p-4 text-right">${nightlyDisplay}</td>
                            <td class="p-4 text-right font-bold text-blue-700">${totalVariablesDisplay}</td>
                        </tr>`;
            }).join('');
        };

        const createEmployeeSearchableDropdown = (container, placeholder, getSourceArray, onSelect) => {
            const id = `searchable-employee-${crypto.randomUUID()}`;
            container.innerHTML = `<div class="searchable-dropdown w-full"><input type="text" id="${id}-input" placeholder="${placeholder}" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm" autocomplete="off" data-selected-id=""><div id="${id}-list" class="searchable-dropdown-list hidden"></div></div>`;
            const input = document.getElementById(`${id}-input`), list = document.getElementById(`${id}-list`);
            let highlightIndex = -1;
            const updateList = () => { const source = getSourceArray(); const searchTerm = input.value.toLowerCase(); const filtered = source.filter(e => e.name.toLowerCase().includes(searchTerm)); list.innerHTML = filtered.map(e => `<div class="searchable-dropdown-item" data-id="${e.id}">${e.name}</div>`).join(''); list.classList.toggle('hidden', list.innerHTML === ''); highlightIndex = -1; };
            const selectItem = (item) => { if (!item) return; const id = item.dataset.id; const source = getSourceArray(); const employee = source.find(e => e.id === id); input.value = employee ? employee.name : ''; input.dataset.selectedId = id; onSelect({ id }); list.classList.add('hidden'); };
            input.addEventListener('input', updateList);
            input.addEventListener('focus', updateList);
            input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
            list.addEventListener('mousedown', (e) => selectItem(e.target.closest('.searchable-dropdown-item')));
            input.addEventListener('keydown', (e) => { const items = list.querySelectorAll('.searchable-dropdown-item'); if (!items.length) return; if (e.key === 'ArrowDown') highlightIndex = (highlightIndex + 1) % items.length; else if (e.key === 'ArrowUp') highlightIndex = (highlightIndex - 1 + items.length) % items.length; else if (e.key === 'Enter') { e.preventDefault(); if (highlightIndex > -1) selectItem(items[highlightIndex]); } else if (e.key === 'Escape') list.classList.add('hidden'); else return; items.forEach((item, index) => item.classList.toggle('highlighted', index === highlightIndex)); });
            return input;
        };
        const createCompanySearchableDropdown = (container, placeholder, allowCreate, onSelect, initialId = null) => {
            const id = `searchable-company-${crypto.randomUUID()}`;
            container.innerHTML = `<div class="searchable-dropdown w-full"><input type="text" id="${id}-input" placeholder="${placeholder}" class="w-full p-2 border border-slate-300 rounded-lg shadow-sm" autocomplete="off" data-selected-id=""><div id="${id}-list" class="searchable-dropdown-list hidden"></div></div>`;
            const input = document.getElementById(`${id}-input`), list = document.getElementById(`${id}-list`);
            
            const setInitialValue = (companyId) => {
                const company = state.companies.find(c => c.id === companyId);
                input.value = company ? company.nome : (companyId === '' ? 'Todas as Empresas' : '');
                input.dataset.selectedId = companyId;
            };

            if (initialId !== null) setInitialValue(initialId);
            
            let highlightIndex = -1;
            const updateList = () => { const searchTerm = input.value.toLowerCase(); const filtered = state.companies.filter(c => c.nome.toLowerCase().includes(searchTerm) || c.codigo.toLowerCase().includes(searchTerm)); list.innerHTML = ''; if (allowCreate && searchTerm && !filtered.some(c => c.nome.toLowerCase() === searchTerm || c.codigo.toLowerCase() === searchTerm)) { list.innerHTML += `<div class="searchable-dropdown-item font-medium text-blue-600" data-action="create" data-value="${input.value}">+ Adicionar nova empresa "${input.value}"</div>`; } if (!allowCreate) { list.innerHTML += `<div class="searchable-dropdown-item" data-id="">Todas as Empresas</div>`; } filtered.forEach(c => { list.innerHTML += `<div class="searchable-dropdown-item" data-id="${c.id}">${c.nome} <small class="ml-2">(${c.codigo})</small></div>`; }); list.classList.toggle('hidden', list.innerHTML === ''); highlightIndex = -1; };
            const selectItem = (item) => { if (!item) return; const id = item.dataset.id; const action = item.dataset.action; if(action === 'create') { onSelect({ action: 'create', value: item.dataset.value }); } else { setInitialValue(id); onSelect({ action: 'select', id }); } list.classList.add('hidden'); };
            input.addEventListener('input', updateList);
            input.addEventListener('focus', updateList);
            input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
            list.addEventListener('mousedown', (e) => selectItem(e.target.closest('.searchable-dropdown-item')));
            input.addEventListener('keydown', (e) => { const items = list.querySelectorAll('.searchable-dropdown-item'); if (!items.length) return; if (e.key === 'ArrowDown') highlightIndex = (highlightIndex + 1) % items.length; else if (e.key === 'ArrowUp') highlightIndex = (highlightIndex - 1 + items.length) % items.length; else if (e.key === 'Enter') { e.preventDefault(); if (highlightIndex > -1) selectItem(items[highlightIndex]); } else if (e.key === 'Escape') list.classList.add('hidden'); else return; items.forEach((item, index) => item.classList.toggle('highlighted', index === highlightIndex)); });
            
            return { input, setInitialValue };
        };
        const addNameSuggestions = (inputElement) => {
            const container = inputElement.parentElement;
            const listId = `suggestion-list-${crypto.randomUUID()}`;
            let list = document.getElementById(listId);
            if (list) list.remove();
            list = document.createElement('div');
            list.id = listId;
            list.className = 'searchable-dropdown-list hidden';
            container.style.position = 'relative';
            container.appendChild(list);
            const updateSuggestions = () => { const searchTerm = inputElement.value.toLowerCase(); if (searchTerm.length < 2) { list.classList.add('hidden'); return; } const filtered = state.employees.filter(e => e.name.toLowerCase().includes(searchTerm)); if (filtered.length === 0) { list.classList.add('hidden'); return; } list.innerHTML = filtered.map(e => `<div class="searchable-dropdown-item" data-id="${e.id}">${e.name} <small class="ml-2">já cadastrado</small></div>`).join(''); list.classList.remove('hidden'); };
            const selectSuggestion = (item) => { if (!item) return; const employee = state.employees.find(e => e.id === item.dataset.id); if (employee) { list.classList.add('hidden'); closeEmployeeModal(); openEmployeeModal({ isEditing: true, employeeData: employee }); } };
            const inputHandler = () => updateSuggestions();
            const blurHandler = () => setTimeout(() => list.classList.add('hidden'), 200);
            const mousedownHandler = (e) => selectSuggestion(e.target.closest('.searchable-dropdown-item'));
            inputElement.addEventListener('input', inputHandler);
            inputElement.addEventListener('focus', updateSuggestions);
            inputElement.addEventListener('blur', blurHandler);
            list.addEventListener('mousedown', mousedownHandler);
            return () => { inputElement.removeEventListener('input', inputHandler); inputElement.removeEventListener('focus', updateSuggestions); inputElement.removeEventListener('blur', blurHandler); list.removeEventListener('mousedown', mousedownHandler); if (list) list.remove(); };
        };

        // --- FIREBASE FUNCTIONS ---
        const getEmployeeCollection = () => collection(db, `/artifacts/${appId}/users/${userId}/employees`);
        const getCompanyCollection = () => collection(db, `/artifacts/${appId}/users/${userId}/companies`);
        const getTimesheetCollection = () => collection(db, `/artifacts/${appId}/users/${userId}/timesheets`);
        const getSettingsDoc = () => doc(db, `/artifacts/${appId}/users/${userId}/settings/main`);

        const saveEmployee = async (id, data) => await setDoc(doc(getEmployeeCollection(), id), data);
        const saveCompany = async (id, data) => await setDoc(doc(getCompanyCollection(), id), data);
        const saveSettings = async () => {
            const settings = {
                nightlyStart: document.getElementById('nightly-start').value,
                nightlyEnd: document.getElementById('nightly-end').value,
                nightlyPercentage: document.getElementById('nightly-percentage').value,
                balanceTolerance: document.getElementById('balance-tolerance').value,
            };
            await setDoc(getSettingsDoc(), settings);
        };
        const deleteEmployeeAndTimesheets = async (id) => {if (!id) return;await deleteDoc(doc(getEmployeeCollection(), id));const batch = writeBatch(db);Object.keys(state.timesheets).filter(key => key.startsWith(id + '_')).forEach(key => batch.delete(doc(getTimesheetCollection(), key)));await batch.commit();closeDeleteModal();};
        const deleteCompany = async (id) => { if (!id) return; await deleteDoc(doc(getCompanyCollection(), id)); closeDeleteModal(); };
        const saveTimesheetData = async (employeeId, month, year, data) => {if (!employeeId) return;const timesheetId = `${employeeId}_${year}-${String(month + 1).padStart(2, '0')}`;await setDoc(doc(getTimesheetCollection(), timesheetId), { data });};
        
        const detachListeners = () => {
            if (unsubscribeCompanies) unsubscribeCompanies();
            if (unsubscribeEmployees) unsubscribeEmployees();
            if (unsubscribeTimesheets) unsubscribeTimesheets();
            if (unsubscribeSettings) unsubscribeSettings();
        };

        const setupListeners = () => {
            detachListeners(); 
            unsubscribeCompanies = onSnapshot(getCompanyCollection(), (snapshot) => { state.companies = snapshot.docs.map(doc => doc.data()).sort((a,b) => (a.codigo || "").localeCompare(b.codigo || "")); renderCompanyList(); renderEmployeeList(); renderReport(); });
            unsubscribeEmployees = onSnapshot(getEmployeeCollection(), (snapshot) => { state.employees = snapshot.docs.map(doc => doc.data()).sort((a, b) => a.name.localeCompare(b.name)); renderCompanyList(); renderEmployeeList(); renderReport(); });
            unsubscribeTimesheets = onSnapshot(getTimesheetCollection(), (snapshot) => { state.timesheets = {}; snapshot.docs.forEach(doc => { state.timesheets[doc.id] = doc.data().data; }); renderReport(); if (document.getElementById('apontamentos-tab').classList.contains('active')) { renderTimesheet(); } });
            unsubscribeSettings = onSnapshot(getSettingsDoc(), (snapshot) => {
                if(snapshot.exists()) {
                    const settings = snapshot.data();
                    document.getElementById('nightly-start').value = settings.nightlyStart || '22:00';
                    document.getElementById('nightly-end').value = settings.nightlyEnd || '05:00';
                    document.getElementById('nightly-percentage').value = settings.nightlyPercentage || '20';
                    document.getElementById('balance-tolerance').value = settings.balanceTolerance || '0';
                }
            });
        };

        // --- EVENT HANDLERS & MODAL LOGIC ---
        const addClickOutsideToClose = (modalElement, closeFunction) => {
            modalElement.addEventListener('mousedown', (e) => {
                if (e.target === modalElement) {
                    modalElement.addEventListener('mouseup', (upEvent) => {
                        if (upEvent.target === modalElement) {
                            closeFunction();
                        }
                    }, { once: true });
                }
            });
        };

        const switchToTab = (tabId) => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');document.getElementById(`${tabId}-tab`).classList.remove('hidden');if (tabId === 'relatorio') renderReport();if (tabId === 'apontamentos') renderTimesheet();if (tabId === 'empresas') renderCompanyList();
        };
        
        const openEmployeeModal = (options = {}) => {
            employeeForm.reset();
            employeeCompanyError.textContent = '';
            if (cleanupNameSuggestions) { cleanupNameSuggestions(); cleanupNameSuggestions = null; }

            let initialData = { isEditing: false, id: crypto.randomUUID(), name: '', salary: '', workload: '08:00', companyId: '', paymentType: 'monthly', notes: '' };

            if (employeeModalState) {
                const restoredState = { ...employeeModalState };
                employeeModalState = null;
                initialData = { ...restoredState, companyId: restoredState.newCompanyId, isEditing: restoredState.isEditing || false };
            } else if (options.isEditing) {
                initialData = { ...initialData, ...options.employeeData, isEditing: true };
            } else if (options.prefillCompanyId) {
                initialData.companyId = options.prefillCompanyId;
            }
            
            modalTitle.textContent = initialData.isEditing ? 'Editar Funcionário' : 'Adicionar Funcionário';
            document.getElementById('employee-id').value = initialData.id;
            const nameInput = document.getElementById('employee-name');
            nameInput.value = initialData.name;
            document.getElementById('employee-salary').value = initialData.salary;
            document.getElementById('employee-workload').value = initialData.workload || '08:00';
            document.getElementById('employee-notes').value = initialData.notes || '';
            if (!initialData.isEditing) { cleanupNameSuggestions = addNameSuggestions(nameInput); }
            
            const setPaymentTypeUI = (type) => {
                document.getElementById('employee-payment-type').value = type;
                document.querySelectorAll('.payment-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
                const isHourly = type === 'hourly';
                document.getElementById('workload-wrapper').style.display = isHourly ? 'none' : 'block';
                document.getElementById('salary-label').textContent = isHourly ? 'Valor por Hora (R$)' : 'Salário (R$)';
                document.getElementById('employee-workload').required = !isHourly; 
            };

            setPaymentTypeUI(initialData.paymentType || 'monthly');
            
            const companyDropdown = createCompanySearchableDropdown(employeeCompanyContainer, "Pesquisar empresa...", true, (selection) => {
                 if (selection.action === 'create') { 
                    employeeModalState = { ...initialData };
                    delete employeeModalState.isEditing;
                    closeEmployeeModal(); 
                    companyToCreateFromModal = selection.value; 
                    openCompanyModal();
                } else { 
                    const company = state.companies.find(c => c.id === selection.id); 
                    if(company) { 
                        companyDropdown.input.value = company.nome; 
                        companyDropdown.input.dataset.selectedId = company.id; 
                    } 
                }
            }, initialData.companyId);
            
            employeeModal.classList.remove('hidden'); employeeModal.classList.add('flex');
        };

        const closeEmployeeModal = () => { if (cleanupNameSuggestions) { cleanupNameSuggestions(); cleanupNameSuggestions = null; } employeeModal.classList.add('hidden'); };
        const openCompanyModal = (company = null) => { companyForm.reset(); const nameInput = document.getElementById('company-name'), codeInput = document.getElementById('company-code'); if (company) { document.getElementById('company-modal-title').textContent = 'Editar Empresa'; document.getElementById('company-id').value = company.id; codeInput.value = company.codigo; nameInput.value = company.nome; document.getElementById('company-cnpj').value = company.cnpj || ''; document.getElementById('company-notes').value = company.notes || ''; } else { document.getElementById('company-modal-title').textContent = 'Adicionar Empresa'; document.getElementById('company-id').value = crypto.randomUUID(); if(companyToCreateFromModal){ if(/^\d+$/.test(companyToCreateFromModal)){ codeInput.value = companyToCreateFromModal; } else { nameInput.value = companyToCreateFromModal; } companyToCreateFromModal = null; } } companyModal.classList.remove('hidden'); companyModal.classList.add('flex'); };
        const closeCompanyModal = () => companyModal.classList.add('hidden');
        const openDeleteModal = (id, type) => {
            let text;
            confirmDeleteBtn.disabled = false;
            if (type === 'employee') {
                const employee = state.employees.find(e => e.id === id);
                if (!employee) return;
                itemToDelete = { id, type, name: employee.name };
                text = `Tem certeza de que deseja excluir o funcionário <strong>${itemToDelete.name}</strong>? Todos os seus apontamentos também serão apagados. Esta ação não pode ser desfeita.`;
            } else if (type === 'company') {
                const company = state.companies.find(c => c.id === id);
                if (!company) return;
                itemToDelete = { id, type, name: company.nome };
                const employeeCount = state.employees.filter(e => e.companyId === id).length;
                if (employeeCount > 0) {
                    text = `Não é possível excluir a empresa <strong>${itemToDelete.name}</strong> pois ela possui <strong>${employeeCount}</strong> funcionário(s). Por favor, reatribua ou exclua os funcionários primeiro.`;
                    confirmDeleteBtn.disabled = true;
                } else {
                    text = `Tem certeza de que deseja excluir a empresa <strong>${itemToDelete.name}</strong>? Esta ação não pode ser desfeita.`;
                }
            }
            deleteConfirmText.innerHTML = text;
            deleteConfirmModal.classList.remove('hidden');
            deleteConfirmModal.classList.add('flex');
        };
        const closeDeleteModal = () => {deleteConfirmModal.classList.add('hidden');itemToDelete = { id: null, type: null, name: '' };};

        const handleEmployeeFormSubmit = async (e) => {
            e.preventDefault();
            employeeCompanyError.textContent = '';
            const companyInput = employeeCompanyContainer.querySelector('input');
            const companyId = companyInput.dataset.selectedId || "";

            if (!companyId) {
                employeeCompanyError.textContent = 'A seleção de uma empresa é obrigatória.';
                return;
            }
            
            const id = document.getElementById('employee-id').value;
            const employeeData = {
                id,
                name: document.getElementById('employee-name').value,
                salary: document.getElementById('employee-salary').value || "0",
                companyId,
                workload: document.getElementById('employee-workload').value,
                paymentType: document.getElementById('employee-payment-type').value,
                notes: document.getElementById('employee-notes').value
            };
            await saveEmployee(id, employeeData);
            closeEmployeeModal();
        };
        const handleCompanyFormSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('company-id').value;
            const companyData = {
                id,
                codigo: document.getElementById('company-code').value,
                nome: document.getElementById('company-name').value,
                cnpj: document.getElementById('company-cnpj').value,
                notes: document.getElementById('company-notes').value
            };
            await saveCompany(id, companyData);
            closeCompanyModal();
            if (employeeModalState) {
                employeeModalState.newCompanyId = id;
                setTimeout(() => openEmployeeModal({ isEditing: employeeModalState.isEditing, employeeData: employeeModalState }), 150);
            }
        };
        const handleConfirmDelete = () => {if (itemToDelete.type === 'employee') deleteEmployeeAndTimesheets(itemToDelete.id);else if (itemToDelete.type === 'company') deleteCompany(itemToDelete.id);};
        const handleDateChange = (e) => {
            if(state.hasUnsavedChanges) {
                if(!confirm("Você tem alterações não salvas que serão perdidas. Deseja continuar?")) {
                    e.target.value = e.target.id === 'month-select' ? state.currentMonth : state.currentYear;
                    return;
                }
            }
            state.currentMonth = parseInt(monthSelect.value);
            state.currentYear = parseInt(yearSelect.value);
            renderTimesheet();
            renderReport();
        };
        
        const generateExportHtml = (employee, company, timesheetData, monthName) => {
            const timeCellExport = (decimalHours) => `${minutesToTime(decimalToMinutes(decimalHours))} (${formatDecimal(decimalHours)})`;
            const balanceCellExport = (decimalHours) => `${minutesToTime(decimalToMinutes(decimalHours), true)} (${formatDecimal(decimalHours)})`;

            const rowsHtml = Array.from({ length: new Date(state.currentYear, state.currentMonth + 1, 0).getDate() }, (_, i) => i + 1).map(day => {
                const dayStr = String(day).padStart(2, '0');
                const dayData = timesheetData[dayStr] || {};
                const date = new Date(state.currentYear, state.currentMonth, day);
                const dayOfWeek = date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
                const { totalWorkedHours, balanceHours, overtime50Hours, overtime100Hours, nightlyHoursRaw } = calculateDayTotals(dayData, employee);
                const balanceDisplay = employee.paymentType === 'hourly' ? '---' : balanceCellExport(balanceHours);
                const statusDisplay = statusMap[dayData.status || 'workday'] || 'Trabalho';
                return `
                    <tr>
                        <td>${dayStr}</td><td>${dayOfWeek}</td><td>${statusDisplay}</td>
                        <td>${dayData.entry1 || '--:--'}</td><td>${dayData.exit1 || '--:--'}</td>
                        <td>${dayData.entry2 || '--:--'}</td><td>${dayData.exit2 || '--:--'}</td>
                        <td>${timeCellExport(totalWorkedHours)}</td><td>${balanceDisplay}</td>
                        <td>${dayData.manual_extra50 ? dayData.extra50 : timeCellExport(overtime50Hours)}</td>
                        <td>${dayData.manual_extra100 ? dayData.extra100 : timeCellExport(overtime100Hours)}</td>
                        <td>${timeCellExport(nightlyHoursRaw)}</td>
                    </tr>`;
            }).join('');

            const monthTotals = calculateMonthTotals(employee);
            const hourlyRate = (employee.paymentType === 'hourly') ? parseFloat(employee.salary || 0) : (parseFloat(employee.salary || 0) / 220);
            const extra50Value = monthTotals.extra50 * hourlyRate * 1.5;
            const extra100Value = monthTotals.extra100 * hourlyRate * 2.0;
            const nightlyValue = monthTotals.nightly * hourlyRate * (parseFloat(document.getElementById('nightly-percentage').value) / 100);
            
            const summaryHtml = `
                <div class="summary-section">
                    <h3>Resumo do Mês</h3>
                    <div class="summary-grid">
                        <span>Total Horas Trabalhadas:</span><strong>${timeCellExport(monthTotals.totalWorked)}</strong>
                        ${employee.paymentType !== 'hourly' ? `<span>Saldo Banco de Horas:</span><strong>${balanceCellExport(monthTotals.balance)}</strong>` : '<span></span><span></span>'}
                        <span>Faltas:</span><strong>${monthTotals.absences} dias</strong>
                        <span>Total H.E. 50%:</span><strong>${timeCellExport(monthTotals.extra50)} (${formatCurrency(extra50Value)})</strong>
                        <span>Total H.E. 100%:</span><strong>${timeCellExport(monthTotals.extra100)} (${formatCurrency(extra100Value)})</strong>
                        <span>Total Ad. Noturno (Pago):</span><strong>${timeCellExport(monthTotals.nightly)} (${formatCurrency(nightlyValue)})</strong>
                        <span class="total">Valor Total de Variáveis:</span><strong class="total">${formatCurrency(extra50Value + extra100Value + nightlyValue)}</strong>
                    </div>
                </div>`;

            return `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Espelho de Ponto - ${employee.name}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif, Arial; font-size: 9pt; color: #333; }
                        .header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10px; border-bottom: 2px solid #0056b3; margin-bottom: 15px; }
                        .header-info h1 { font-size: 14pt; margin: 0; color: #0056b3; }
                        .header-info p { margin: 2px 0; font-size: 10pt; }
                        .header-period { text-align: right; }
                        .header-period p { margin: 2px 0; font-size: 10pt; font-weight: 500;}
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
                        th { background-color: #f0f4f8; font-weight: 600; font-size: 8pt;}
                        .summary-section { margin-top: 20px; }
                        .summary-section h3 { font-size: 12pt; color: #0056b3; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                        .summary-grid { display: grid; grid-template-columns: auto auto; gap: 5px 15px; width: fit-content; }
                        .summary-grid span { text-align: right; }
                        .summary-grid .total { font-weight: bold; margin-top: 5px; padding-top: 5px; border-top: 1px solid #999;}
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="header-info">
                             <h1>Espelho de Ponto</h1>
                             <p><strong>Funcionário:</strong> ${employee.name}</p>
                             <p><strong>Empresa:</strong> ${company ? company.nome : 'N/A'}</p>
                        </div>
                        <div class="header-period">
                             <p><strong>Período de Apuração</strong></p>
                             <p>${monthName} de ${state.currentYear}</p>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Dia</th><th>Semana</th><th>Status</th><th>Ent. 1</th><th>Saí. 1</th><th>Ent. 2</th><th>Saí. 2</th><th>Total Trab.</th><th>Saldo</th><th>H.E. 50%</th><th>H.E. 100%</th><th>Ad. Noturno</th></tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                    ${summaryHtml}
                </body>
                </html>`;
        };

        const handlePdfExport = () => {
            if (!state.currentEmployeeId) { alert("Por favor, selecione um funcionário para exportar."); return; }
            const employee = state.employees.find(e => e.id === state.currentEmployeeId);
            const company = state.companies.find(c => c.id === employee.companyId);
            const timesheetId = `${state.currentEmployeeId}_${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
            const timesheetData = state.timesheets[timesheetId] || {};
            const monthName = monthSelect.options[monthSelect.selectedIndex].text;

            const printHtml = generateExportHtml(employee, company, timesheetData, monthName);
            const finalHtml = printHtml.replace('</body>', '<button class="print-btn" onclick="window.print()" style="display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; cursor: pointer;">Imprimir</button></body>');
            
            const win = window.open('', '_blank');
            win.document.write(finalHtml);
            win.document.close();
        };
        
        const handleXlsExport = () => {
            if (!state.currentEmployeeId) { alert("Por favor, selecione um funcionário para exportar."); return; }
            const employee = state.employees.find(e => e.id === state.currentEmployeeId);
            const company = state.companies.find(c => c.id === employee.companyId);
            const timesheetId = `${state.currentEmployeeId}_${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
            const timesheetData = state.timesheets[timesheetId] || {};
            const monthName = monthSelect.options[monthSelect.selectedIndex].text;

            const htmlContent = generateExportHtml(employee, company, timesheetData, monthName);
            
            const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            
            const monthStr = String(state.currentMonth + 1).padStart(2, '0');
            const fileName = `Apontamentos_${employee.name.replace(/\s+/g, '_')}_${monthStr}-${state.currentYear}.xls`;
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const handleSaveTimesheet = async () => { 
            if (!state.hasUnsavedChanges || !state.currentEmployeeId) return; 
            updateSaveStatus(true); 
            const timesheetId = `${state.currentEmployeeId}_${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}`;
            state.timesheets[timesheetId] = JSON.parse(JSON.stringify(state.localTimesheet));
            await saveTimesheetData(state.currentEmployeeId, state.currentMonth, state.currentYear, state.timesheets[timesheetId]); 
            state.hasUnsavedChanges = false; 
            updateSaveStatus(false, true); 
        };

        const handleTimesheetInputChange = (e) => { 
            const { day, field } = e.target.dataset; 
            const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value; 
            const currentEmployee = state.employees.find(emp => emp.id === state.currentEmployeeId); 
            if (!currentEmployee) return; 
            if (!state.localTimesheet[day]) state.localTimesheet[day] = {}; 
            const dayData = state.localTimesheet[day]; 
            dayData[field] = value; 
            const row = e.target.closest('tr'); 
            const status = row.querySelector('.status-select').value; 
            const isWorkday = !['absent', 'day_off', 'certificate'].includes(status); 
            row.querySelectorAll('.time-input, .manual-input, .workload-input').forEach(input => input.disabled = !isWorkday); 
            row.classList.toggle('bg-slate-200', !isWorkday); 
            row.classList.toggle('text-slate-600', !isWorkday); 
            if (!isWorkday) { 
                row.querySelectorAll('.time-input').forEach(i => i.value = ''); 
                Object.assign(dayData, { entry1: '', exit1: '', entry2: '', exit2: '' }); 
            } 
            const { totalWorkedHours, balanceHours, overtime50Hours, overtime100Hours, nightlyHours, nightlyHoursRaw } = calculateDayTotals(dayData, currentEmployee); 
            
            dayData.nightly = minutesToTime(decimalToMinutes(nightlyHours));

            if (e.target.classList.contains('manual-input')) { 
                dayData[`manual_${field}`] = true; 
            } else if (['time-input', 'workload-input', 'status-select'].some(c => e.target.classList.contains(c)) || field === 'is_holiday') { 
                delete dayData.manual_extra50; 
                delete dayData.manual_extra100;
            } 
            dayData.extra50 = dayData.manual_extra50 ? dayData.extra50 : minutesToTime(decimalToMinutes(overtime50Hours));
            dayData.extra100 = dayData.manual_extra100 ? dayData.extra100 : minutesToTime(decimalToMinutes(overtime100Hours));
            
            row.querySelector('td:nth-child(9)').textContent = minutesToTime(decimalToMinutes(totalWorkedHours));
            const balanceCell = row.querySelector('td:nth-child(10)'); 
            balanceCell.textContent = currentEmployee.paymentType === 'hourly' ? 'N/A' : minutesToTime(decimalToMinutes(balanceHours), true);
            balanceCell.className = `p-2 text-center font-semibold ${balanceHours < 0 ? 'text-red-500' : 'text-green-600'}`; 
            
            row.querySelector('[data-field="extra50"]').value = dayData.extra50; 
            row.querySelector('[data-field="extra100"]').value = dayData.extra100; 
            row.querySelector('td:nth-child(13)').textContent = minutesToTime(decimalToMinutes(nightlyHoursRaw));

            if (!state.hasUnsavedChanges) { 
                state.hasUnsavedChanges = true; 
                updateSaveStatus(); 
            } 
            renderTimesheetSummary(); 
        };
        const handleTimesheetNavigation = (e) => { const target = e.target; if (!target.matches('.time-input, .workload-input, .manual-input, .status-select, [data-field="is_holiday"]')) return; const key = e.key; if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) return; e.preventDefault(); const currentTr = target.closest('tr'); const currentTd = target.closest('td'); if (!currentTr || !currentTd) return; const allRows = Array.from(timesheetBody.rows); const rowIndex = allRows.indexOf(currentTr); const cellIndex = Array.from(currentTr.cells).indexOf(currentTd); let nextFocusable = null; if (key === 'ArrowUp' && rowIndex > 0) { nextFocusable = allRows[rowIndex - 1].cells[cellIndex]?.querySelector('input:not([disabled]), select:not([disabled])'); } else if (key === 'ArrowDown' && rowIndex < allRows.length - 1) { nextFocusable = allRows[rowIndex + 1].cells[cellIndex]?.querySelector('input:not([disabled]), select:not([disabled])'); } else if (key === 'ArrowLeft') { let prevTd = currentTd.previousElementSibling; while (prevTd && !nextFocusable) { nextFocusable = prevTd.querySelector('input:not([disabled]), select:not([disabled])'); prevTd = prevTd.previousElementSibling; } } else if (key === 'ArrowRight') { let nextTd = currentTd.nextElementSibling; while (nextTd && !nextFocusable) { nextFocusable = nextTd.querySelector('input:not([disabled]), select:not([disabled])'); nextTd = nextTd.nextElementSibling; } } if (nextFocusable) { nextFocusable.focus(); if (typeof nextFocusable.select === 'function') nextFocusable.select(); } };

        // --- INICIALIZAÇÃO ---
        const init = () => {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, (user) => {
                loadingEl.style.display = 'none';
                clearUI();
                
                if (user) {
                    userId = user.uid;
                    mainContentEl.classList.remove('hidden');

                    if(user.isAnonymous){
                        loginBtn.classList.remove('hidden');
                        userInfoEl.classList.add('hidden');
                    } else {
                        loginBtn.classList.add('hidden');
                        userInfoEl.classList.remove('hidden');
                        userEmailEl.textContent = user.email;
                    }

                    if (!appComponentsInitialized) { 
                        initializeAppComponents(); 
                    }
                    setupListeners();

                } else {
                    signInAnonymously(auth).catch(err => {
                        console.error("Anonymous sign-in failed after state change:", err);
                        mainContentEl.innerHTML = `<p class="text-center text-red-500">Erro de autenticação. Verifique as configurações do Firebase.</p>`;
                        mainContentEl.classList.remove('hidden');
                    });
                }
            });
        };
        
        const clearUI = () => {
             state = { employees: [], companies: [], timesheets: {}, localTimesheet: {}, currentEmployeeId: null, apontamentoCompanyId: null, reportCompanyFilter: '', currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), searchTerm: '', companyFilter: '', hasUnsavedChanges: false };
             employeeList.innerHTML = '';
             companyListBody.innerHTML = '';
             timesheetBody.innerHTML = '';
             reportBody.innerHTML = '';
             detachListeners();
        };

        const initializeAppComponents = () => {
            appComponentsInitialized = true;
            
            const handleNavigationWithUnsavedChanges = (callback) => {
                if (state.hasUnsavedChanges) {
                    if (!confirm("Você tem alterações não salvas que serão perdidas. Deseja continuar?")) {
                        return false;
                    }
                }
                callback();
                return true;
            };

            apontamentoCompanyInput = createCompanySearchableDropdown(apontamentoCompanyContainer, "Pesquisar empresa...", false, (selection) => { handleNavigationWithUnsavedChanges(() => { if (selection.action === 'select') { state.apontamentoCompanyId = selection.id; state.currentEmployeeId = null; if(apontamentoEmployeeInput) { apontamentoEmployeeInput.value = ''; apontamentoEmployeeInput.dataset.selectedId = ''; apontamentoEmployeeInput.disabled = !selection.id; apontamentoEmployeeInput.placeholder = selection.id ? "Pesquisar funcionário..." : "Selecione uma empresa"; } renderTimesheet(); const company = state.companies.find(c=>c.id === selection.id); if(company) {apontamentoCompanyInput.input.value = company.nome;} else {apontamentoCompanyInput.input.value = "Todas as Empresas"} } })}).input;
            apontamentoEmployeeInput = createEmployeeSearchableDropdown(apontamentoEmployeeContainer, "Selecione uma empresa", () => state.apontamentoCompanyId ? state.employees.filter(e => e.companyId === state.apontamentoCompanyId) : [], (selection) => { handleNavigationWithUnsavedChanges(() => { if (selection.id) { state.currentEmployeeId = selection.id; renderTimesheet(); const employee = state.employees.find(emp=>emp.id === selection.id); if(employee){apontamentoEmployeeInput.value = employee.name; apontamentoEmployeeInput.dataset.selectedId = employee.id;} } })});
            apontamentoEmployeeInput.disabled = true;

            filterCompanyInput = createCompanySearchableDropdown(filterCompanyContainer, "Filtrar por empresa...", false, (selection) => { if (selection.action === 'select') { state.companyFilter = selection.id; renderEmployeeList(); const company = state.companies.find(c => c.id === selection.id); filterCompanyInput.input.value = company ? company.nome : 'Todas as Empresas'; } });
            createCompanySearchableDropdown(reportCompanyContainer, "Filtrar por empresa...", false, (selection) => { if (selection.action === 'select') { state.reportCompanyFilter = selection.id; renderReport(); const input = reportCompanyContainer.querySelector('input'); const company = state.companies.find(c => c.id === selection.id); input.value = company ? company.nome : 'Todas as Empresas'; } });

            populateDateSelectors();

            document.querySelector('[aria-label="Tabs"]').addEventListener('click', (e) => { if (e.target.classList.contains('tab-button')) { switchToTab(e.target.dataset.tab); }});
            addEmployeeBtn.addEventListener('click', () => openEmployeeModal());
            addCompanyBtn.addEventListener('click', () => openCompanyModal());
            cancelBtn.addEventListener('click', closeEmployeeModal);
            cancelCompanyBtn.addEventListener('click', closeCompanyModal);
            
            addClickOutsideToClose(employeeModal, closeEmployeeModal);
            addClickOutsideToClose(companyModal, closeCompanyModal);
            addClickOutsideToClose(deleteConfirmModal, closeDeleteModal);
            addClickOutsideToClose(authModal, () => { authModal.classList.add('hidden'); authModal.classList.remove('flex'); });

            employeeModal.querySelector('.payment-type-container').addEventListener('click', (e) => {
                const button = e.target.closest('.payment-type-btn');
                if (button) {
                    const type = button.dataset.type;
                    document.getElementById('employee-payment-type').value = type;
                    employeeModal.querySelectorAll('.payment-type-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === type);
                    });
                    const isHourly = type === 'hourly';
                    document.getElementById('workload-wrapper').style.display = isHourly ? 'none' : 'block';
                    document.getElementById('salary-label').textContent = isHourly ? 'Valor por Hora (R$)' : 'Salário (R$)';
                    document.getElementById('employee-workload').required = !isHourly;
                }
            });

            employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
            companyForm.addEventListener('submit', handleCompanyFormSubmit);
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            monthSelect.addEventListener('change', handleDateChange);
            yearSelect.addEventListener('change', handleDateChange);
            searchEmployeeInput.addEventListener('input', e => { state.searchTerm = e.target.value; renderEmployeeList(); });
            exportPdfBtn.addEventListener('click', handlePdfExport);
            exportXlsBtn.addEventListener('click', handleXlsExport);
            saveTimesheetBtn.addEventListener('click', handleSaveTimesheet);
            employeeList.addEventListener('click', (e) => { 
                const row = e.target.closest('tr'); if (!row) return; 
                const id = row.dataset.id; 
                if (e.target.classList.contains('edit-btn')) {
                    openEmployeeModal({ isEditing: true, employeeData: state.employees.find(emp => emp.id === id) });
                } else if (e.target.classList.contains('delete-btn')) {
                     openDeleteModal(id, 'employee');
                } else if (e.target.classList.contains('go-to-timesheet-btn')) { 
                    handleNavigationWithUnsavedChanges(() => {
                        const employee = state.employees.find(emp => emp.id === id); 
                        if(employee){ 
                            const company = state.companies.find(c => c.id === employee.companyId); 
                            state.apontamentoCompanyId = employee.companyId; 
                            state.currentEmployeeId = id; 
                            if (apontamentoCompanyInput && company) { 
                                apontamentoCompanyInput.value = company.nome; 
                                apontamentoCompanyInput.dataset.selectedId = company.id; 
                            } else { 
                                apontamentoCompanyInput.value = ''; 
                            } 
                            if (apontamentoEmployeeInput) { 
                                apontamentoEmployeeInput.value = employee.name; 
                                apontamentoEmployeeInput.dataset.selectedId = id; 
                                apontamentoEmployeeInput.disabled = false; 
                            } 
                            switchToTab('apontamentos'); 
                        }
                    }); 
                } 
            });
            companyListBody.addEventListener('click', (e) => { 
                const row = e.target.closest('tr'); if (!row) return; 
                const id = row.dataset.id; 
                if (e.target.classList.contains('edit-company-btn')) {
                    openCompanyModal(state.companies.find(c => c.id === id)); 
                } else if (e.target.classList.contains('delete-company-btn')) {
                    openDeleteModal(id, 'company'); 
                } else if (e.target.classList.contains('view-employees-btn')) {
                    state.companyFilter = id;
                    filterCompanyInput.setInitialValue(id);
                    renderEmployeeList();
                    switchToTab('funcionarios');
                } else if (e.target.classList.contains('add-employee-to-company-btn')) {
                    openEmployeeModal({ prefillCompanyId: id });
                }
            });
            timesheetBody.addEventListener('change', handleTimesheetInputChange);
            timesheetBody.addEventListener('keydown', handleTimesheetNavigation);
            
            const timeInputHandler = e => { if (e.target.matches('.time-input, .workload-input, .manual-input, #employee-workload')) { const input = e.target; let value = input.value.replace(/\D/g, ''); input.value = value.length > 2 ? value.slice(0, 2) + ':' + value.slice(2, 4) : value; } };
            const timeBlurHandler = e => { if (e.target.matches('.time-input, .workload-input, .manual-input, #employee-workload')) { const input = e.target; if (input.value.length > 0 && !/^\d{2}:\d{2}$/.test(input.value)) input.value = ''; else if (input.value) { const [hours, minutes] = input.value.split(':').map(Number); if (hours > 23 || minutes > 59) input.value = ''; } } };

            document.body.addEventListener('input', timeInputHandler);
            document.body.addEventListener('blur', timeBlurHandler, true);

            document.querySelectorAll('.setting-input').forEach(input => {
                input.addEventListener('change', () => {
                    saveSettings();
                    if (document.getElementById('apontamentos-tab').classList.contains('active')) {
                        renderTimesheet();
                    }
                    renderReport();
                });
            });

            document.body.addEventListener('mouseover', e => {
                const icon = e.target.closest('.has-tooltip-icon');
                if (icon) {
                    const notes = icon.dataset.notes;
                    globalTooltip.textContent = notes;
                    const rect = icon.getBoundingClientRect();
                    globalTooltip.style.left = `${rect.left + (rect.width / 2)}px`;
                    globalTooltip.style.top = `${rect.top}px`;
                    globalTooltip.style.transform = `translateX(-50%) translateY(-100%) translateY(-8px)`;
                    globalTooltip.style.visibility = 'visible';
                    globalTooltip.style.opacity = '1';
                }
            });
            document.body.addEventListener('mouseout', e => {
                const icon = e.target.closest('.has-tooltip-icon');
                if (icon) {
                    globalTooltip.style.visibility = 'hidden';
                    globalTooltip.style.opacity = '0';
                }
            });
        };
        
        // --- Lógica de Autenticação ---
        loginBtn.addEventListener('click', () => { authModal.classList.remove('hidden'); authModal.classList.add('flex'); });
        closeAuthModalBtn.addEventListener('click', () => { authModal.classList.add('hidden'); authModal.classList.remove('flex'); });
        
        showRegisterViewBtn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            document.getElementById('register-email').value = document.getElementById('login-email').value;
            document.getElementById('register-password').value = document.getElementById('login-password').value;
            loginView.classList.add('hidden'); 
            registerView.classList.remove('hidden'); 
        });
        showLoginViewBtn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            document.getElementById('login-email').value = document.getElementById('register-email').value;
            document.getElementById('login-password').value = document.getElementById('register-password').value;
            registerView.classList.add('hidden'); 
            loginView.classList.remove('hidden'); 
        });
        logoutBtn.addEventListener('click', () => { signOut(auth); });

        loginForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            loginErrorEl.textContent = ''; 
            const email = document.getElementById('login-email').value; 
            const password = document.getElementById('login-password').value; 
            const rememberMe = document.getElementById('remember-me').checked;
            const persistence = rememberMe ? indexedDBLocalPersistence : browserSessionPersistence;
            try { 
                await setPersistence(auth, persistence);
                await signInWithEmailAndPassword(auth, email, password); 
                authModal.classList.add('hidden'); 
                authModal.classList.remove('flex'); 
            } catch (error) { 
                console.error("Login error:", error.code, error.message);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    loginErrorEl.textContent = 'Credenciais inválidas. Verifique os dados.';
                } else {
                    loginErrorEl.textContent = 'Ocorreu um erro ao tentar entrar.';
                }
            } 
        });
        registerForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            registerErrorEl.textContent = ''; 
            const email = document.getElementById('register-email').value; 
            const password = document.getElementById('register-password').value; 
            
            try {
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    const credential = EmailAuthProvider.credential(email, password);
                    await linkWithCredential(auth.currentUser, credential);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password); 
                }
                authModal.classList.add('hidden'); 
                authModal.classList.remove('flex'); 
            } catch (error) { 
                console.error("Register/Link error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use' || error.code === 'auth/credential-already-in-use') {
                     registerErrorEl.textContent = 'Este e-mail já está em uso.';
                } else if (error.code === 'auth/weak-password') { 
                    registerErrorEl.textContent = 'A senha deve ter no mínimo 6 caracteres.'; 
                } else if (error.code === 'auth/invalid-email') { 
                    registerErrorEl.textContent = 'O formato do e-mail é inválido.'; 
                } else { 
                    registerErrorEl.textContent = 'Ocorreu um erro ao criar a conta.'; 
                } 
            } 
        });
        
        init();
    </script>
</body>
</html>

